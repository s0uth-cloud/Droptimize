rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------
    // USERS COLLECTION
    // ----------------------------
    match /users/{userId} {

      // Allow authenticated users to list/query users collection for email validation during signup
      // Also allow admins and dispatchers to list all users in their branch
      allow list: if request.auth != null;

      // Read own user document, or if admin, or if dispatcher reading users in same branch
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == resource.data.branchId
        )
      );

      // Allow user to create their own document (new registration)
      // Also allow creation if authenticated with Firebase Auth but document doesn't exist yet
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow user to update their own document, or admin/dispatcher to update any user in their branch
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == resource.data.branchId
        )
      );

      // Allow delete by self or admin
      allow delete: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );

      // -----------------------------------
      // Violations Subcollection under Users
      // -----------------------------------
      match /violations/{violationId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
        );

        allow create: if request.auth != null && (
          request.auth.uid == userId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
        );

        allow update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
      }
    }

    // ----------------------------
    // PREFERRED ROUTES (user subcollection)
    // ----------------------------
    match /users/{userId}/preferredRoutes/{routeId} {
      allow read, create, update, delete: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    // ----------------------------
    // BRANCHES COLLECTION
    // ----------------------------
    match /branches/{branchId} {
      // Allow any authenticated user to read branches (for join code lookup)
      allow read: if request.auth != null;

      // Create if the authenticated user is setting themselves as the admin
      allow create: if request.auth != null &&
        request.resource.data.adminId == request.auth.uid;

      // Update/delete only by admin of the branch
      allow update, delete: if request.auth != null &&
        resource.data.adminId == request.auth.uid;

      // Slowdowns subcollection
      match /slowdowns/{slowdownId} {
        allow read, write: if request.auth != null && (
          get(/databases/$(database)/documents/branches/$(branchId)).data.adminId == request.auth.uid ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == branchId
        );
      }
    }

    // ----------------------------
    // PARCELS COLLECTION
    // ----------------------------
    match /parcels/{parcelId} {
      // Allow reading if:
      // - Driver assigned to the parcel
      // - Admin (any branch)
      // - Dispatcher in the same branch as the parcel
      // - Driver in same branch as parcel (for scanning)
      allow read: if request.auth != null && (
        resource.data.driverUid == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == resource.data.branchId
        ) ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "driver" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == resource.data.branchId
        )
      );

      // Allow list/query operations for drivers to search by reference
      allow list: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["admin", "dispatcher", "driver"]
      );

      // Allow admin, dispatcher (same branch), and driver (with branchId) to create parcels
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["admin", "dispatcher"] ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "driver" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId != null &&
          request.resource.data.branchId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId
        )
      );

      allow update: if request.auth != null && (
        (
          resource.data.driverUid == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['status', 'DeliveredAt', 'FailedAt', 'DeliveryNotes', 'updatedAt', 'driverUid', 'driverName', 'assignedAt'])
        ) ||
        (
          // Allow driver to assign themselves to unassigned parcels (for assignment acceptance)
          // Check if parcel is unassigned (driverUid is null or doesn't exist)
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "driver" &&
          (!('driverUid' in resource.data) || resource.data.driverUid == null) &&
          request.resource.data.driverUid == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['status', 'updatedAt', 'driverUid', 'driverName', 'assignedAt'])
        ) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == resource.data.branchId
        )
      );

      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // ----------------------------
    // ASSIGNMENTS COLLECTION
    // ----------------------------
    match /assignments/{assignmentId} {
      // Allow admin and dispatcher to create assignments
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["admin", "dispatcher"]
      );

      // Allow reading if:
      // - Driver assigned to the assignment
      // - Admin (any branch)
      // - Dispatcher who created it
      allow read: if request.auth != null && (
        resource.data.driverId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher"
      );

      // Allow driver to update only their own assignment (accept/reject)
      // Allow admin/dispatcher to update any assignment
      allow update: if request.auth != null && (
        resource.data.driverId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["admin", "dispatcher"]
      );

      // Only admin can delete assignments
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // ----------------------------
    // DRIVERS COLLECTION
    // ----------------------------
    match /drivers/{driverId} {
      allow read: if request.auth != null;

      allow write, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";

      match /violations/{violationId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher'];
        allow update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
      }
    }

    // ----------------------------
    // ETAs COLLECTION
    // ----------------------------
    match /etas/{driverId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == driverId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    // ----------------------------
    // WARNINGS COLLECTION
    // ----------------------------
    match /warnings/{warningId} {
      allow read, create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId != null
      );

      allow update, delete: if false;
    }
  }
}
