rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------
    // USERS COLLECTION
    // ----------------------------
    match /users/{userId} {

      // Allow admins and dispatchers to list all users in their branch
      allow list: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher"
      );

      // Read own user document, or if admin, or if dispatcher reading users in same branch
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == resource.data.branchId
        )
      );

      // Allow user to create their own document (new registration)
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow user to update their own document, or admin/dispatcher to update any user in their branch
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "dispatcher" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == resource.data.branchId
        )
      );

      // Allow delete by self or admin
      allow delete: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );

      // -----------------------------------
      // Violations Subcollection under Users
      // -----------------------------------
      match /violations/{violationId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
        );

        allow create: if request.auth != null && (
          request.auth.uid == userId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
        );

        allow update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
      }
    }

    // ----------------------------
    // PREFERRED ROUTES (user subcollection)
    // ----------------------------
    match /users/{userId}/preferredRoutes/{routeId} {
      allow read, create, update, delete: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    // ----------------------------
    // BRANCHES COLLECTION
    // ----------------------------
    match /branches/{branchId} {
      // Allow any authenticated user to read branches (for join code lookup)
      allow read: if request.auth != null;

      // Create if the authenticated user is setting themselves as the admin
      allow create: if request.auth != null &&
        request.resource.data.adminId == request.auth.uid;

      // Update/delete only by admin of the branch
      allow update, delete: if request.auth != null &&
        resource.data.adminId == request.auth.uid;

      // Slowdowns subcollection
      match /slowdowns/{slowdownId} {
        allow read, write: if request.auth != null && (
          get(/databases/$(database)/documents/branches/$(branchId)).data.adminId == request.auth.uid ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId == branchId
        );
      }
    }

    // ----------------------------
    // PARCELS COLLECTION
    // ----------------------------
    match /parcels/{parcelId} {
      allow read: if request.auth != null && (
        resource.data.driverUid == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );

      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["admin", "dispatcher"];

      allow update: if request.auth != null && (
        (
          resource.data.driverUid == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['status', 'DeliveredAt', 'CancelledAt', 'DeliveryNotes', 'updatedAt'])
        ) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );

      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // ----------------------------
    // DRIVERS COLLECTION
    // ----------------------------
    match /drivers/{driverId} {
      allow read: if request.auth != null;

      allow write, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";

      match /violations/{violationId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher'];
        allow update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
      }
    }

    // ----------------------------
    // ETAs COLLECTION
    // ----------------------------
    match /etas/{driverId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == driverId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    // ----------------------------
    // WARNINGS COLLECTION
    // ----------------------------
    match /warnings/{warningId} {
      allow read, create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId != null
      );

      allow update, delete: if false;
    }
  }
}
